# Lesson 06: コードレビュー

## 概要
このレッスンでは、code-reviewer agentを活用してコードレビューを行う方法を学びます。

**所要時間**: 約30分

## 学習目標
- code-reviewer agentの活用
- 効果的なレビューコメントの書き方
- PRレビューのワークフロー
- レビュー指摘への対応

---

## 課題: PRのレビュー

他の開発者が作成した（または自分で作成した）PRをレビューします。

---

## Step 1: レビュー対象の準備

### 1.1 サンプルPRの作成

練習用に、意図的に問題のあるコードを含むPRを作成します:

```
feature/sample-review というブランチを作成して、
以下の問題を含むコードを追加して:
1. 未使用の変数
2. エラーハンドリングの不足
3. ハードコードされた値
```

### 1.2 PRの作成

```
/create-pr
```

---

## Step 2: code-reviewer agentによるレビュー

### 2.1 レビューの実行

```
このPRをレビューして
```

または特定のPRをレビュー:

```
PR #123 をレビューして
```

### 2.2 レビュー観点

code-reviewer agentは以下の観点でレビューします:

| カテゴリ | チェック内容 |
|---------|------------|
| **品質** | コード重複、複雑度、可読性 |
| **セキュリティ** | 入力バリデーション、認証、データ保護 |
| **パフォーマンス** | N+1問題、メモリ使用、効率性 |
| **テスト** | カバレッジ、エッジケース |
| **設計** | SOLID原則、責務分離 |

### 2.3 レビュー結果の例

```
## コードレビュー結果

### 必須の修正 (Must Fix)

1. **セキュリティ**: 入力値の検証がありません
   - ファイル: TaskController.java:42
   - 説明: ユーザー入力を直接使用しています
   - 推奨: @Validアノテーションを追加

2. **バグ**: NullPointerExceptionの可能性
   - ファイル: TaskService.java:55
   - 説明: nullチェックなしでメソッド呼び出し
   - 推奨: Optional使用またはnullチェック追加

### 推奨の修正 (Should Fix)

3. **可読性**: 未使用の変数
   - ファイル: TaskService.java:30
   - 説明: `tempResult`は宣言されているが使用されていない
   - 推奨: 変数を削除

### 提案 (Suggestions)

4. **改善**: 定数の使用
   - ファイル: TaskController.java:15
   - 説明: マジックナンバー "100" が使用されている
   - 推奨: 定数として定義
```

---

## Step 3: レビュー指摘への対応

### 3.1 指摘の優先順位

| 優先度 | 対応 |
|-------|------|
| Must Fix | マージ前に必ず修正 |
| Should Fix | 可能な限り修正 |
| Suggestions | 検討して対応判断 |

### 3.2 指摘への対応

```
レビューで指摘された項目を修正して
```

または個別に:

```
TaskController.java:42 の入力バリデーションを追加して
```

### 3.3 修正後の再レビュー

```
修正内容を再度レビューして
```

---

## Step 4: レビューコメントの書き方

### 4.1 効果的なレビューコメント

**良いコメントの例**:
```
@@ -42,6 +42,7 @@ public class TaskController {
+    // ここで入力のnullチェックが必要です。
+    // task.getTitle()がnullの場合、後続の処理でNPEが発生します。
+    // 以下のように修正することを推奨:
+    // if (task.getTitle() == null) throw new BadRequestException("Title is required");
```

### 4.2 避けるべきコメント

| NG | OK |
|----|-----|
| 「これはダメ」 | 「この実装には〜という問題があります。〜のように改善できます」 |
| 「なんでこう書いたの？」 | 「この設計の意図を教えてください」 |
| 「普通はこうしない」 | 「〜のパターンを使うと〜の利点があります」 |

### 4.3 建設的なフィードバック

```
このPRのレビューコメントを
建設的で具体的な内容で作成して
```

---

## Step 5: 自動レビューの設定

### 5.1 レビュー観点のカスタマイズ

`.claude/agents/code-reviewer.md`で観点をカスタマイズできます:

```markdown
# Code Reviewer Agent

## 重点チェック項目
- セキュリティ（最優先）
- パフォーマンス
- テストカバレッジ

## プロジェクト固有のルール
- Lombokの使用禁止
- Stream APIの優先使用
- 日本語コメント必須
```

---

## 実践課題

### 課題1: セルフレビュー

これまでのレッスンで書いたコードをレビュー:

```
Lesson 02-05 で追加したコードをレビューして、
改善点があれば教えて
```

### 課題2: 特定観点でのレビュー

```
パフォーマンスの観点のみでTaskServiceをレビューして
```

### 課題3: レビューの自動化

```
pre-pushフックでcode-reviewerを自動実行する設定を作成して
```

---

## レビューのベストプラクティス

### レビュアーとして

1. **目的を理解**: PRの目的を最初に確認
2. **全体→詳細**: まず全体像を把握してから詳細を見る
3. **質問する**: 不明点は指摘ではなく質問として
4. **良い点も伝える**: 改善点だけでなく良い点も
5. **具体的に**: 曖昧な指摘を避ける

### レビューを受ける側として

1. **小さなPR**: レビューしやすいサイズに分割
2. **説明を書く**: 変更の意図を明記
3. **セルフレビュー**: 提出前に自分でレビュー
4. **迅速な対応**: 指摘には早めに対応
5. **議論を歓迎**: 異論は建設的に議論

---

## チェックポイント

このレッスンを完了したら、以下ができるようになっているはずです:

- [ ] code-reviewer agentでレビューを実行できる
- [ ] レビュー指摘の優先順位を理解している
- [ ] 効果的なレビューコメントを書ける
- [ ] 指摘事項に適切に対応できる

---

## 次のステップ

コードレビューをマスターしたら、[Lesson 07: カスタマイズ](./07-custom-commands.md)に進みましょう。ここでは独自のコマンドやスキルの作成を学びます。
