---
name: performance
description: パフォーマンス最適化のチェックリストとベストプラクティス。遅いコードや最適化が必要な場合に参照。
---

# パフォーマンス最適化ガイド

## データベース最適化

### N+1クエリ問題
```
❌ 悪い: ループ内でクエリを実行（N回）
✅ 良い: JOINまたはeager loadingで1回のクエリに
✅ 良い: バッチクエリで一括取得
```

### インデックス
- 頻繁に検索するカラムにインデックスを作成
- 複合インデックスはカラム順序が重要（左端から使用される）
- 部分インデックスで特定条件のクエリを高速化
- インデックスの過剰作成は書き込み性能に影響

### クエリ最適化
- SELECT * を避け、必要なカラムのみ取得
- COUNT はDBで実行（全件取得してからカウントしない）
- EXPLAIN で実行計画を確認
- 大量データは分割して処理

## フロントエンド最適化

### レンダリング最適化
- 不要な再レンダリングを避ける
- 計算結果のメモ化
- コンポーネントの適切な分割
- 仮想スクロール（大量リスト）

### 遅延読み込み
- コンポーネントの遅延読み込み
- 画像の遅延読み込み（loading="lazy"）
- ルートベースのコード分割

### バンドルサイズ削減
- 必要な機能のみインポート（ツリーシェイキング）
- 軽量な代替ライブラリを検討
- バンドル分析ツールで確認

## バックエンド最適化

### キャッシング
```
1. キャッシュチェック
2. ヒット → キャッシュから返す
3. ミス → 計算/取得してキャッシュに保存
4. 適切なTTLを設定
5. 更新時にキャッシュを無効化
```

### ページネーション
- **オフセットベース**: 小規模データ向け（LIMIT/OFFSET）
- **カーソルベース**: 大規模データ向け（WHERE id > cursor）

### 並列処理
```
❌ 悪い: 順次実行（依存関係がないのに待つ）
✅ 良い: 並列実行（Promise.all など）
```

### 非同期処理
- 重い処理はバックグラウンドジョブに
- キュー（ジョブキュー）の活用
- タイムアウトの設定

## チェックリスト

### データベース
- [ ] N+1クエリがないか
- [ ] 適切なインデックスがあるか
- [ ] 必要なカラムのみ取得しているか
- [ ] ページネーションを実装しているか
- [ ] スロークエリをモニタリングしているか

### フロントエンド
- [ ] 不要な再レンダリングがないか
- [ ] 遅延読み込みを使用しているか
- [ ] バンドルサイズは適切か
- [ ] 画像は最適化されているか
- [ ] Core Web Vitals は良好か

### バックエンド
- [ ] キャッシングを活用しているか
- [ ] 非同期処理を並列化しているか
- [ ] 重い処理はバックグラウンドジョブにしているか
- [ ] タイムアウトを設定しているか

## 計測の原則

1. **推測するな、計測せよ**: 最適化前に必ずプロファイリング
2. **ボトルネックを特定**: 影響が大きい箇所から対処
3. **ベンチマークを取る**: 最適化前後で比較
4. **トレードオフを考慮**: 可読性・保守性とのバランス

## 計測ツール

### フロントエンド
- ブラウザ開発者ツール（Performance タブ）
- Lighthouse
- Web Vitals

### バックエンド
- APMツール（New Relic, Datadog など）
- プロファイラ
- ログ分析

### データベース
- EXPLAIN / EXPLAIN ANALYZE
- スロークエリログ
- クエリアナライザ
