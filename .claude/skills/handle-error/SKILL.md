---
name: handle-error
description: 堅牢なエラーハンドリングパターンとベストプラクティス。例外処理やエラー境界を実装する際に参照。
---

# Handle Error Skill

エラーハンドリングのガイドを提供します。

## 基本原則

1. **早期失敗**: 問題を早期に検出して報告
2. **適切な粒度**: 具体的すぎず、抽象的すぎない
3. **回復可能性**: 回復可能なエラーと致命的エラーを区別
4. **ユーザーフレンドリー**: 技術的詳細を隠し、意味のあるメッセージを

## カスタムエラークラスの設計

### 階層構造
```
AppError (ベース)
├── ValidationError    (400 Bad Request)
├── AuthenticationError (401 Unauthorized)
├── AuthorizationError  (403 Forbidden)
├── NotFoundError       (404 Not Found)
├── ConflictError       (409 Conflict)
└── InternalError       (500 Internal Error)
```

### エラークラスの属性
- `message`: ユーザー向けメッセージ
- `code`: 機械可読なエラーコード
- `statusCode`: HTTPステータスコード
- `isOperational`: 運用エラーか（true）プログラミングエラーか（false）
- `details`: 追加情報（バリデーションエラーのフィールドなど）

## エラーハンドリングパターン

### 1. 集中エラーハンドラー
- アプリケーション全体で一貫したエラー処理
- ログ出力の統一
- 適切なレスポンス形式

### 2. 非同期ラッパー
- 非同期関数のエラーを自動キャッチ
- try-catch の繰り返しを削減

### 3. Result型パターン
```
成功時: { success: true, data: T }
失敗時: { success: false, error: E }
```
- 例外を使わずにエラーを表現
- 呼び出し側でのエラーハンドリングを強制

## エラーレスポンス形式

### APIレスポンス
```
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力内容に問題があります",
    "details": [
      { "field": "email", "message": "有効なメールアドレスを入力してください" }
    ]
  }
}
```

### ログ出力
```
{
  "level": "error",
  "message": "エラーメッセージ",
  "code": "ERROR_CODE",
  "stack": "スタックトレース（開発環境のみ）",
  "context": { "userId": "123", "action": "createOrder" }
}
```

## 環境別の動作

### 開発環境
- 詳細なスタックトレースを表示
- デバッグ情報を含める
- エラーの原因を明確に

### 本番環境
- スタックトレースを隠す
- ユーザーフレンドリーなメッセージ
- 詳細はログに記録

## チェックリスト

- [ ] カスタムエラークラスを定義している
- [ ] 適切なHTTPステータスコードを返している
- [ ] エラーログを記録している
- [ ] 本番環境で詳細を隠している
- [ ] ユーザーフレンドリーなメッセージを表示
- [ ] UIにエラー境界を実装している（フロントエンド）
- [ ] 非同期エラーを適切にキャッチしている
- [ ] 予期しないエラーも適切に処理している

## アンチパターン

### ❌ 避けるべきこと
- 空の catch ブロック
- エラーを握りつぶす
- スタックトレースの破棄
- 一般的すぎるエラーメッセージ
- 機密情報をエラーに含める

### ✅ すべきこと
- 具体的なエラータイプを使用
- エラーの原因を保持（cause プロパティ）
- 適切なログレベルを使用
- 回復可能な場合はリトライ
